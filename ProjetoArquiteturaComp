ORG 0000H

; Definições dos pinos
REGISTRADOR_SELECT    EQU    P1.3
PINO_ATIVAR           EQU    P1.2

InicioProg:
    Clr REGISTRADOR_SELECT        
    Call InicializarTela    
    Call ConfigurarTela    
    Call ConfigEntrada        
    SetB REGISTRADOR_SELECT        
    Mov DPTR,#TabelaMensagens
    
LoopPrincipal:
    Clr A
    Movc A,@A+DPTR    
    Jz ProximaSecao        
    Call EnviarCaractere    
    Inc DPTR        
    Jmp LoopPrincipal

ProximaSecao:
    Mov R4,#00h    
    Mov R5,#00h    
    Mov DPTR,#CodigoSeguro    

LoopEntrada:
    Call LerTeclado    
    SetB REGISTRADOR_SELECT        
    Clr A
    Mov A,#'@'        
    Call EnviarCaractere    
    
    Clr A
    Movc A,@A+DPTR    
    Call ValidarEntrada    
    Inc DPTR
    Inc R4
    Cjne R4,#04h,LoopEntrada
    
    Cjne R5,#04h,AcessoNegado    

AcessoPermitido:
    Call PosicionarCursor
    SetB REGISTRADOR_SELECT        
    Call MostrarPermitido
    SETB P3.0 
    CLR P3.1 
    
    MOV R6, #0 
    MOV R7, #200      
    
ContadorTempo:
    DJNZ R7, ContadorTempo 
    CLR P3.0 
    Jmp ProximaSecao

AcessoNegado:
    Call PosicionarCursor
    SetB REGISTRADOR_SELECT        
    Call MostrarNegado
    Jmp ProximaSecao
                
InicializarTela:
    Clr  P1.7        
    Clr  P1.6        
    SetB P1.5        
    Clr  P1.4    
    
    Call AtivarPino
    Call Esperar        
    Call AtivarPino
                    
    SetB P1.7        
    Clr  P1.6
    Clr  P1.5
    Clr  P1.4
        
    Call AtivarPino
    Call Esperar
    Ret

ConfigurarTela:
    Clr P1.7        
    Clr P1.6        
    Clr P1.5        
    Clr P1.4      
    Call AtivarPino
    SetB P1.7        
    SetB P1.6        
    SetB P1.5        
    SetB P1.4        
    Call AtivarPino
    Call Esperar            
    Ret

ConfigEntrada:
    Clr P1.7        
    Clr P1.6        
    Clr P1.5        
    Clr P1.4        
    Call AtivarPino
    Clr  P1.7        
    SetB P1.6        
    SetB P1.5        
    Clr  P1.4        
    Call AtivarPino
    Call Esperar        
    Ret
    
AtivarPino:
    SetB PINO_ATIVAR        
    Clr  PINO_ATIVAR        
    Ret
    
EnviarCaractere:
    Mov C, ACC.7        
    Mov P1.7, C        
    Mov C, ACC.6        
    Mov P1.6, C        
    Mov C, ACC.5        
    Mov P1.5, C        
    Mov C, ACC.4        
    Mov P1.4, C        
    Call AtivarPino
    Mov C, ACC.3        
    Mov P1.7, C        
    Mov C, ACC.2        
    Mov P1.6, C        
    Mov C, ACC.1        
    Mov P1.5, C        
    Mov C, ACC.0        
    Mov P1.4, C        
    Call AtivarPino
    Call Esperar        
    Mov R1,#45h        
    Ret
Esperar:
    Mov R0, #45        
    Djnz R0, $
    Ret
            
LerTeclado:
    CLR P0.3            
    CALL LerLinha0        
    SetB P0.3            
    JB F0,FimTeclado
                    
    CLR P0.2            
    CALL LerLinha1        
    SetB P0.2            
    JB F0,FimTeclado
                    
    CLR P0.1            
    CALL LerLinha2        
    SetB P0.1            
    JB F0,FimTeclado                        
    CLR P0.0            
    CALL LerLinha3        
    SetB P0.0            
    JB F0,FimTeclado                        
    JMP LerTeclado                            
                        
FimTeclado:
    Clr F0                
    Ret

LerLinha0:
    JNB P0.4, Tecla03    
    JNB P0.5, Tecla13    
    JNB P0.6, Tecla23    
    RET         
